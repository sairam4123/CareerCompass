import { useState } from "react";
import { NavBar } from "./components/NavBar";
import { First } from "./pages/First";
import Question from "./pages/Question";

import questions from "./datasets/questions.json";
import Result from "./pages/Result";
import { api } from "./lib/api";
import useMutation from "./lib/useMutation";
import { BasicAnswersType, QuestionType } from "./@types/Question";
import { ChoiceType } from "./@types/Choice";
import { useNavigate } from "react-router";
import { Bounce, toast, ToastContainer } from "react-toastify";

type AppStateType = "BEGIN" | "QUESTIONNAIRE" | "AI_QUESTIONNAIRE" | "DONE";

function App() {
  const findAnswer = (question: number, choice: number) => {
    return (
      questions
        .find((q) => q.question === question + 1)
        ?.choices.find((c) => c.choice === choice)?.label ?? "No answer."
    );
  };
  const [choices, setChoices] = useState<number[]>([]);

  const answers = choices.map((choice, index) => {
    return findAnswer(index, choice);
  });

  const [appState, setAppState] = useState<AppStateType>("BEGIN");
  const [curQuestion, setCurQuestion] = useState<number>(0);
  const [question, setQuestion] = useState<QuestionType>(questions[0]);
  const [maxQuestions, setMaxQuestions] = useState<number>(questions.length);
  const navigate = useNavigate();

  const [userId, setUserId] = useState<string>(""); // User ID for AI questionnaire

  const [aiAnswers, setAiAnswers] = useState<string[]>([]);
  const questionMutation = useMutation<
    { success: true; userId: string; question: QuestionType; max_questions: number } | { success: false, message: string },
    BasicAnswersType
  >({
    url: `${api}/answers`,
    method: "POST",
    onSuccess: (data) => {
      if (!data.success) {
        toast.error(`Failed to submit answers. Please try again later. Error: ${data.message}`);
        return;
      }
      const { userId, question, max_questions } = data;
      setMaxQuestions(max_questions);
      setAppState("AI_QUESTIONNAIRE");
      setQuestion(question);
      setUserId(userId);
    },
    onFailure: (error) => {
      toast.error(`Failed to submit answers. Please try again later. ${error}`);
    }
  });
  

  const nextQuestionMutation = useMutation<
    { success: true; question: QuestionType } | { success: false, message: string },
    ChoiceType
  >({
    url: `${api}/answers/${userId}`,
    method: "POST",
    onSuccess: (data) => {
      if (!data.success) {
        toast.error(`Failed to submit answers. Please try again later. Error: ${data.message}`);
        return;
      }
      const { question } = data;
      setQuestion(question);
    },
    onFailure: (error) => {
      toast.error(`Failed to submit answers. Please try again later. ${error}`);
    }
  });

  return (
    <>
      <NavBar />
      {appState === "BEGIN" && (
        <First onBegin={() => setAppState("QUESTIONNAIRE")} />
      )}
      {appState === "QUESTIONNAIRE" && (
        <Question
          isLoading={false}
          disablePrev={curQuestion === 0}
          disableNext={curQuestion === questions.length - 1}
          disableSubmit={curQuestion !== questions.length - 1}
          question={questions[curQuestion]}
          maxQuestions={questions.length}
          selectedAnswer={choices[curQuestion]}
          key={`question`}
          onAnswer={(answer) => {
            setChoices([
              ...choices.slice(0, curQuestion),
              answer,
              ...choices.slice(curQuestion + 1),
            ]);
            if (curQuestion === questions.length - 1) {
              setAppState("DONE");
              console.log(answers);
              questionMutation.mutate({
                age_group: answers[0],
                gender: answers[1],
                education: findAnswer(2, answer),
              });
              return;
            }
            setCurQuestion((prev) => prev + 1);
          }}
          onPrev={() => {
            setCurQuestion((prev) => prev - 1);
          }}
        ></Question>
      )}
      {appState === "DONE" && <Result />}
      {appState === "AI_QUESTIONNAIRE" && (
        <Question
          disablePrev={true}
          isLoading={nextQuestionMutation.status === "LOADING"}
          maxQuestions={maxQuestions}
          question={question}
          selectedAnswer={-1}
          disableNext={question.question === maxQuestions}
          disableSubmit={question.question !== maxQuestions}
          note="Note: These questions are generated by AI and may not be accurate."
          onAnswer={(answer) => {
            setAiAnswers([
              ...aiAnswers,
              question.choices.find((c) => c.choice === answer)?.label ??
                "No answer.",
            ]);
            if (question.question === maxQuestions) {
              setAppState("DONE");
              navigate(`/result/${userId}`);  
              return;
            }
            nextQuestionMutation.mutate({
              ...question.choices.find((c) => c.choice === answer)!,
            });
          }}
        />
      )}
      <ToastContainer
        position="top-right"
        autoClose={5000}
        hideProgressBar={true}
        newestOnTop={false}
        closeOnClick={true}
        rtl={false}
        pauseOnFocusLoss
        draggable
        pauseOnHover
        theme="light"
        transition={Bounce}
      />
    </>
  );
}

export default App;
